# Story 1.30: Caddy Validation Failure Recovery

**Epic:** Epic 1 - setup-vps.sh Core Functionality Testing
**Priority:** Must-have

## Description

Verify rollback when generated Caddyfile fails validation.

## Acceptance Criteria

- [x] Simulate invalid Caddyfile (e.g., corrupt registry with invalid port type)
- [x] Script attempts `caddy validate` after generation
- [x] On validation failure:
  - Backup of new invalid Caddyfile is saved
  - Previous Caddyfile is restored from backup
  - Caddy is NOT reloaded (old config stays active)
  - Error message logged explaining the failure
  - Exit code 1
- [x] VPS remains functional with previous configuration

## Dependencies

Story 1.17

## Testing Notes

```bash
# Corrupt registry to cause invalid Caddyfile
# e.g., set a domain's port to "abc" instead of number
ssh deploy@vps "sudo jq '.domains[\"example.com\"].port = \"abc\"' /etc/caddy/domains.json > tmp && sudo mv tmp /etc/caddy/domains.json"

./setup-vps.sh --dry-run
# Should fail validation, restore backup, exit 1

# Check that old Caddyfile is restored
ssh deploy@vps "sudo cat /etc/caddy/Caddyfile" | grep "reverse_proxy"
# Should show valid config (or whatever was there before)
```
