# Story 3.4: Domain Type Change - Static to Dynamic

**Epic:** Epic 3 - Integration and End-to-End Testing
**Priority:** Should-have

## Description

Verify full workflow of changing a domain from static to dynamic.

## Acceptance Criteria

- [x] Domain initially set up as static, site deployed and working
- [x] Update `.env.deploy` to `DOMAIN_TYPE=dynamic` with port
- [x] Run `setup-vps.sh`
- [x] Registry updated, Node.js/PM2 installed (if not already)
- [x] Dynamic app directory created
- [x] Caddyfile updated with reverse_proxy
- [x] Caddy reloaded
- [x] Deploy dynamic app code with `deploy.sh`
- [x] Post-deploy: npm install, build, PM2 start
- [x] Domain now serves dynamic app
- [x] Old static files remain in `/var/www/` (not deleted automatically)

## Dependencies

Stories 3.1, 3.2, 1.31

## Testing Notes

```bash
# 1. Setup as static
# 2. Deploy static site
# 3. Verify working: https://example.com

# 4. Change .env.deploy to dynamic
cat > .env.deploy << 'EOF'
VPS_USER=deploy
VPS_IP=your.vps.ip
DOMAIN=example.com
DOMAIN_TYPE=dynamic
DOMAIN_PORT=3000
EOF

# 5. Run setup-vps.sh
./setup-vps.sh

# 6. Verify registry shows dynamic with port
ssh deploy@vps "sudo jq '.domains[\"example.com\"]' /etc/caddy/domains.json"

# 7. Verify Caddyfile has reverse_proxy
ssh deploy@vps "sudo cat /etc/caddy/Caddyfile" | grep -A 5 "example.com"

# 8. Deploy dynamic app code
./deploy.sh

# 9. Verify PM2 running
ssh deploy@vps "pm2 list | grep example.com"

# 10. Test HTTPS: should serve dynamic app
curl -I https://example.com

# 11. Check old static files still exist (not deleted)
ssh deploy@vps "ls -ld /var/www/example.com"
```
