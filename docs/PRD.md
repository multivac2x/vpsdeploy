# PRD: VPS Multi-Domain Deploy Toolkit

## Product Name

**`vps-deploy`** â€” A lightweight, open-source bash toolkit for managing multiple virtual domains (static and dynamic Next.js apps) on a single VPS using Caddy and PM2.

---

## 1. Problem Statement

Developers who self-host multiple websites on a single VPS face repetitive, error-prone manual configuration: installing software, managing Caddy virtual hosts, handling SSL, running Node.js apps with PM2, and deploying code. Each new domain means SSH-ing in, editing configs, restarting services â€” fragmented across terminal history and memory.

**vps-deploy** solves this by providing two scripts that automate the entire lifecycle from a developer's local machine:

1. **`setup-vps.sh`** â€” Provisions and configures the VPS infrastructure (Caddy, PM2, domain routing)
2. **`deploy.sh`** â€” Builds and deploys code to a specific domain

Both scripts are designed to be placed in each project's repository and share a common `.env.deploy` configuration file.

---

## 2. Target User

A developer (or small team) who:
- Owns a single VPS (DigitalOcean, Hetzner, Linode, etc.) running Ubuntu 22.04/24.04
- Hosts multiple domains on that VPS
- Uses Next.js (static export and/or dynamic SSR)
- Wants a simple, scriptable deploy workflow without Docker/Kubernetes/CI complexity
- Values transparency â€” bash scripts they can read, understand, and modify

---

## 3. Architecture Overview

### 3.1 Local Side (Developer Machine)

Each project repository contains:

```
my-nextjs-project/
â”œâ”€â”€ .env.deploy              # Per-repo config (gitignored)
â”œâ”€â”€ .env.deploy.example      # Template (committed)
â”œâ”€â”€ deploy.sh                # Build + rsync/deploy script
â”œâ”€â”€ setup-vps.sh             # VPS infrastructure provisioning script
â”œâ”€â”€ next.config.js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```

### 3.2 Server Side (VPS)

```
/etc/caddy/
â”œâ”€â”€ Caddyfile                # Auto-generated by setup-vps.sh (DO NOT EDIT MANUALLY)
â”œâ”€â”€ domains.json             # Server-side registry of all configured domains
â””â”€â”€ backups/
    â””â”€â”€ Caddyfile.<timestamp>  # Backups before each regeneration

/var/www/
â”œâ”€â”€ pescatoreluca.com/       # Static site files
â””â”€â”€ okrmd.com/               # Static site files

/home/deploy/apps/
â””â”€â”€ provaprova.com/          # Dynamic Next.js app (managed by PM2)

/var/log/caddy/
â”œâ”€â”€ pescatoreluca.com.log    # Per-domain access logs
â”œâ”€â”€ okrmd.com.log
â””â”€â”€ provaprova.com.log
```

### 3.3 The Server-Side Registry (`/etc/caddy/domains.json`)

This is the critical architectural decision. Since each repo only knows about its own domain, the VPS needs a central registry that tracks ALL configured domains. The `setup-vps.sh` script reads this registry, merges the current domain into it, and regenerates the full Caddyfile from it.

**Schema:**

```json
{
  "version": 1,
  "updated_at": "2026-02-17T10:30:00Z",
  "domains": {
    "pescatoreluca.com": {
      "type": "static",
      "added_at": "2026-02-17T10:00:00Z",
      "updated_at": "2026-02-17T10:00:00Z"
    },
    "okrmd.com": {
      "type": "static",
      "added_at": "2026-02-17T10:05:00Z",
      "updated_at": "2026-02-17T10:05:00Z"
    },
    "provaprova.com": {
      "type": "dynamic",
      "port": 3000,
      "app_dir": "/home/deploy/apps/provaprova.com",
      "added_at": "2026-02-17T10:10:00Z",
      "updated_at": "2026-02-17T10:30:00Z"
    }
  }
}
```

**Rules:**
- `setup-vps.sh` is the ONLY writer of this file
- Adding a domain = merge into registry
- Removing a domain = `setup-vps.sh remove` removes from registry
- The Caddyfile is ALWAYS regenerated from the full registry (never edited manually)
- The registry file is owned by the deploy user and stored alongside the Caddyfile

---

## 4. Configuration (`.env.deploy`)

### 4.1 Schema

```bash
# ============================================
# VPS Deploy Configuration
# ============================================
# Copy to .env.deploy and fill in your values.
# NEVER commit .env.deploy to git.
# ============================================

# ----- Required -----
VPS_USER=deploy
VPS_IP=164.90.xxx.xxx
DOMAIN=pescatoreluca.com
DOMAIN_TYPE=static              # static | dynamic

# ----- Required if DOMAIN_TYPE=dynamic -----
DOMAIN_PORT=3000                # Local port the Next.js app listens on

# ----- Optional (defaults shown) -----
# SSH_KEY=~/.ssh/id_ed25519
# SSH_PORT=22
# VPS_BASE_PATH=/var/www                     # Base path for static sites
# VPS_APPS_PATH=/home/deploy/apps            # Base path for dynamic apps
# BUILD_CMD=npm run build
# BUILD_OUTPUT=out                           # For static: the export directory
# PM2_APP_NAME=                              # Defaults to DOMAIN if not set
```

### 4.2 Validation Rules

| Variable | Required | Validation |
|----------|----------|------------|
| `VPS_USER` | Yes | Non-empty string |
| `VPS_IP` | Yes | Valid IPv4 or hostname |
| `DOMAIN` | Yes | Valid domain format (e.g., `example.com`) |
| `DOMAIN_TYPE` | Yes | Must be `static` or `dynamic` |
| `DOMAIN_PORT` | If dynamic | Integer 1024â€“65535 |
| `SSH_PORT` | No | Integer 1â€“65535, default `22` |

---

## 5. Script 1: `setup-vps.sh`

### 5.1 Purpose

Provisions and configures the VPS infrastructure. Designed to be **idempotent** â€” safe to run multiple times. It reads the local `.env.deploy`, SSHes into the VPS, and ensures everything is correctly set up for the specified domain.

### 5.2 Subcommands

```bash
./setup-vps.sh              # Default: setup/update this domain on the VPS
./setup-vps.sh status       # Show all domains registered on the VPS and their status
./setup-vps.sh remove       # Remove this repo's domain from the VPS
```

**Options (apply to all subcommands):**

```bash
--dry-run       # Show what would be done without making changes
--verbose       # Show detailed output for all remote commands
--help          # Show usage information
```

### 5.3 Default Subcommand: Setup/Update

**Phase 1: Local Validation**
1. Load `.env.deploy` from the same directory as the script
2. Validate all required variables (see Â§4.2)
3. If `DOMAIN_TYPE=dynamic`, validate `DOMAIN_PORT` is set and is a valid port number
4. Test SSH connection to VPS (timeout 10s, batch mode)
5. If SSH fails â†’ exit with clear error message showing what to check

**Phase 2: Software Installation (all operations via SSH)**

Each check follows the pattern: check if installed â†’ if not, install â†’ verify.

| Software | Check Command | Install Method |
|----------|---------------|----------------|
| Caddy | `caddy version` | Official apt repository (see Â§8.1) |
| Node.js | `node --version` | nvm (latest LTS) â€” only if ANY domain in registry is dynamic |
| PM2 | `pm2 --version` | `npm install -g pm2` â€” only if ANY domain in registry is dynamic |
| jq | `jq --version` | `apt install jq` (needed for registry JSON manipulation) |

**Important:** Node.js and PM2 should only be installed if at least one domain (current or existing in registry) is of type `dynamic`. Do not install them for a purely static setup.

**Phase 3: Firewall**
1. Check if UFW is active
2. Ensure rules exist for ports 22 (SSH), 80 (HTTP), 443 (HTTPS)
3. If UFW is inactive, enable it (with SSH allowed first to avoid lockout)

**Phase 4: Registry Update**
1. Read `/etc/caddy/domains.json` (create with empty `domains` object if missing)
2. **Port conflict check:** If `DOMAIN_TYPE=dynamic`, verify no OTHER domain in the registry uses the same `DOMAIN_PORT`. If conflict found â†’ exit with error listing the conflicting domain.
3. Merge current domain into registry:
   - If domain is new â†’ add entry
   - If domain exists â†’ update `type`, `port`, `updated_at`
   - If domain type changed (e.g., staticâ†’dynamic) â†’ update and log the change
4. Save updated registry

**Phase 5: Directory Setup**
- If `static`: create `${VPS_BASE_PATH}/${DOMAIN}` and `chown` to `VPS_USER`
- If `dynamic`: create `${VPS_APPS_PATH}/${DOMAIN}` and `chown` to `VPS_USER`
- Create `/var/log/caddy/` if it doesn't exist, ensure Caddy user can write

**Phase 6: Caddy Configuration**
1. Create `/etc/caddy/backups/` directory if missing
2. If an existing Caddyfile exists, copy it to `/etc/caddy/backups/Caddyfile.$(date +%Y%m%d_%H%M%S)`
3. Generate a new Caddyfile from the FULL registry (see Â§5.4 for template)
4. Diff old vs new Caddyfile:
   - If identical â†’ log "No Caddy config changes" and skip reload
   - If different â†’ validate with `caddy validate`, then `systemctl reload caddy`
5. If validation fails â†’ restore backup, log error, exit

**Phase 7: PM2 Setup (only if current domain is dynamic)**
1. Check if a PM2 process with name `${PM2_APP_NAME}` (defaults to `${DOMAIN}`) already exists
2. Check if `${VPS_APPS_PATH}/${DOMAIN}/package.json` exists:
   - If yes â†’ `pm2 restart ${PM2_APP_NAME}` or `pm2 start` if not running
   - If no â†’ skip PM2 start, log reminder: "Deploy your app code to ${VPS_APPS_PATH}/${DOMAIN} then run: pm2 start npm --name '${DOMAIN}' -- start"
3. `pm2 save`
4. Configure `pm2 startup` if not already configured (detect via `systemctl is-enabled pm2-${VPS_USER}`)

**Phase 8: Summary**
Print a status table for ALL domains in the registry:

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ–¥  VPS Domain Status (164.90.xxx.xxx)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  Domain               Type      Port   Status
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pescatoreluca.com    static    -      âœ… Caddy OK
  okrmd.com            static    -      âœ… Caddy OK
  provaprova.com       dynamic   3000   âš ï¸  No app deployed
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**Status checks:**
- Static domain: check if `index.html` exists in the web root â†’ âœ… or âš ï¸
- Dynamic domain: check if PM2 process is running and status is "online" â†’ âœ…, "stopped"/"errored" â†’ âŒ, no process â†’ âš ï¸

### 5.4 Caddyfile Template

The Caddyfile is generated from the registry. Every domain gets a `www` redirect block and a main block.

**For a static domain:**

```caddyfile
# â”€â”€ pescatoreluca.com (static) â”€â”€
www.pescatoreluca.com {
    redir https://pescatoreluca.com{uri} permanent
}

pescatoreluca.com {
    root * /var/www/pescatoreluca.com
    file_server

    try_files {path} {path}.html /index.html

    log {
        output file /var/log/caddy/pescatoreluca.com.log
        format json
    }

    @static path *.css *.js *.png *.jpg *.jpeg *.gif *.svg *.woff *.woff2 *.ico
    header @static Cache-Control "public, max-age=31536000, immutable"

    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    encode gzip
}
```

**For a dynamic domain:**

```caddyfile
# â”€â”€ provaprova.com (dynamic, port 3000) â”€â”€
www.provaprova.com {
    redir https://provaprova.com{uri} permanent
}

provaprova.com {
    reverse_proxy localhost:3000

    log {
        output file /var/log/caddy/provaprova.com.log
        format json
    }

    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    encode gzip
}
```

**Caddyfile generation order:** Domains are sorted alphabetically by name for deterministic output (important for diffing).

### 5.5 `status` Subcommand

1. SSH into VPS
2. Read `/etc/caddy/domains.json`
3. For each domain, check:
   - Caddy: is the domain present in the active Caddyfile?
   - Static: does the web root contain files?
   - Dynamic: is the PM2 process running?
   - SSL: is the certificate valid? (`curl -sI https://${domain}` check for 200)
4. Print the status table (same format as Phase 8)
5. Print Caddy service status (`systemctl is-active caddy`)
6. Print disk usage and memory summary

### 5.6 `remove` Subcommand

1. Load `.env.deploy` to get `DOMAIN`
2. SSH into VPS, read registry
3. If domain not in registry â†’ log "Domain not found" and exit
4. **Confirm with the user** â€” print what will happen and ask `y/N`
5. If confirmed:
   - Remove domain from registry
   - If dynamic: stop and delete PM2 process (`pm2 delete ${DOMAIN}`)
   - Regenerate Caddyfile from updated registry (backup old one first)
   - Validate and reload Caddy
   - Print reminder: "Files at /var/www/${DOMAIN} (or /home/deploy/apps/${DOMAIN}) were NOT deleted. Remove manually if desired."
6. `pm2 save`

---

## 6. Script 2: `deploy.sh`

### 6.1 Purpose

Builds the current project and deploys the output to the correct location on the VPS. Reads domain info from `.env.deploy`.

### 6.2 Usage

```bash
./deploy.sh                  # Build and deploy
./deploy.sh --skip-build     # Deploy existing build output without rebuilding
./deploy.sh --dry-run        # Show what would be transferred
./deploy.sh --verbose        # Detailed rsync output
./deploy.sh --help           # Show usage
```

### 6.3 Flow

**Phase 1: Load Config**
1. Load `.env.deploy`
2. Validate required variables
3. Determine deploy target path:
   - Static: `${VPS_BASE_PATH}/${DOMAIN}/`
   - Dynamic: `${VPS_APPS_PATH}/${DOMAIN}/`

**Phase 2: Build**
1. If `--skip-build` â†’ skip, verify `BUILD_OUTPUT` directory exists
2. Check `package.json` exists (error if not)
3. Run `${BUILD_CMD}`
4. Verify `BUILD_OUTPUT` directory was created
5. Log file count

**Phase 3: Deploy**
1. Test SSH connection
2. Ensure remote directory exists
3. Rsync:
   - **Static sites:** `rsync -az --delete ${BUILD_OUTPUT}/ ${VPS_USER}@${VPS_IP}:${VPS_BASE_PATH}/${DOMAIN}/`
   - **Dynamic sites:** `rsync -az --delete --exclude='node_modules' --exclude='.next/cache' ./ ${VPS_USER}@${VPS_IP}:${VPS_APPS_PATH}/${DOMAIN}/`
4. **Dynamic sites only (post-deploy):**
   - SSH in and run: `cd ${VPS_APPS_PATH}/${DOMAIN} && npm install --production && npm run build`
   - Restart PM2 process: `pm2 restart ${DOMAIN}`

**Phase 4: Summary**
- Print deploy time and verification URL

### 6.4 Static vs Dynamic Deploy Differences

| Aspect | Static | Dynamic |
|--------|--------|---------|
| What is rsynced | `out/` directory only | Entire project (excluding node_modules, .next/cache) |
| Remote target | `/var/www/${DOMAIN}/` | `/home/deploy/apps/${DOMAIN}/` |
| Post-deploy | Nothing | `npm install --production && npm run build && pm2 restart` |
| Build location | Local machine | Local build, remote `npm install` + `npm run build` |

---

## 7. File Inventory

### 7.1 Files to Create

| File | Description | Committed to Git? |
|------|-------------|-------------------|
| `setup-vps.sh` | VPS provisioning script | Yes |
| `deploy.sh` | Build & deploy script | Yes |
| `.env.deploy.example` | Configuration template | Yes |
| `.env.deploy` | Actual configuration (with secrets) | **No** (gitignored) |
| `README.md` | Project documentation | Yes |
| `LICENSE` | MIT license | Yes |
| `.gitignore` | Ignore `.env.deploy`, `out/`, `node_modules/` | Yes |

### 7.2 Files Created on VPS (by `setup-vps.sh`)

| File | Description |
|------|-------------|
| `/etc/caddy/Caddyfile` | Auto-generated Caddy config |
| `/etc/caddy/domains.json` | Domain registry |
| `/etc/caddy/backups/Caddyfile.*` | Timestamped Caddyfile backups |
| `/var/log/caddy/<domain>.log` | Per-domain access logs |

---

## 8. Installation & Dependency Details

### 8.1 Caddy Installation (Ubuntu)

```bash
sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https curl
curl -1sLf 'https://dl.cloudflare.com/caddy/stable/gpg.key' \
  | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg] https://dl.cloudflare.com/caddy/stable/deb/any-version main" \
  | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy -y
```

### 8.2 Node.js Installation (via nvm)

```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
nvm install --lts
```

### 8.3 PM2 Installation

```bash
npm install -g pm2
```

### 8.4 jq Installation

```bash
sudo apt install -y jq
```

---

## 9. Edge Cases & Error Handling

| Scenario | Expected Behavior |
|----------|-------------------|
| First run on a fresh VPS | Installs Caddy, jq, (Node.js+PM2 if dynamic), creates registry, sets up domain |
| Re-run, nothing changed | Detects no config diff, skips Caddy reload, logs "already up to date" |
| New domain added (from a different repo) | Merges into existing registry, regenerates Caddyfile with ALL domains |
| Domain type changed (static â†’ dynamic) | Updates registry, regenerates Caddyfile, installs Node.js/PM2 if needed, creates app directory |
| Domain type changed (dynamic â†’ static) | Updates registry, regenerates Caddyfile, stops PM2 process, prints reminder about old app dir |
| Port conflict (two dynamic apps on same port) | Errors BEFORE applying any changes, lists conflicting domain |
| Dynamic app code not yet deployed | Creates directory, skips PM2 start, prints reminder to deploy |
| Caddy config validation fails after regeneration | Restores backup Caddyfile, reloads old config, exits with error |
| SSH connection fails | Exits immediately with message: check SSH key, user, IP, port |
| `.env.deploy` missing | Exits with template showing how to create one |
| `domains.json` missing or corrupted | Creates a fresh empty registry |
| `domains.json` has invalid JSON | Backs up corrupted file, creates fresh registry, warns user |
| `remove` on domain not in registry | Logs "not found", exits cleanly |
| VPS user doesn't have sudo | Prompts for sudo password (Caddy install/config requires it) |
| Disk full | Rsync will fail â€” script should catch and report |
| Caddy already installed | Skips install, logs version |
| Node.js already installed | Skips install, logs version |

---

## 10. Security Considerations

1. `.env.deploy` is gitignored â€” never committed
2. SSH key authentication only (password auth should be disabled on VPS)
3. UFW firewall enabled with minimal open ports (22, 80, 443)
4. Caddy handles HTTPS automatically (Let's Encrypt / ZeroSSL)
5. Security headers on all domains (X-Content-Type-Options, X-Frame-Options, Referrer-Policy)
6. The `deploy` user has sudo access but the scripts minimize sudo usage (only for Caddy config and package installation)
7. PM2 runs as the non-root `deploy` user

---

## 11. README.md Content Outline

The README should cover:

1. **What is vps-deploy** â€” one-paragraph description
2. **Quick Start** â€” 5-step getting started (copy scripts, configure, setup VPS, deploy)
3. **Prerequisites** â€” VPS requirements, local requirements
4. **Configuration** â€” `.env.deploy` reference table
5. **Usage**
   - `setup-vps.sh` (setup, status, remove)
   - `deploy.sh` (deploy, skip-build, dry-run)
6. **How It Works** â€” architecture diagram (text-based), registry explanation
7. **Adding a New Domain** â€” step-by-step for adding from a new repo
8. **Switching Static â†” Dynamic** â€” what to change and what happens
9. **Manual VPS Setup** â€” link to the VPS setup guide (for understanding what the scripts automate)
10. **Troubleshooting** â€” common issues and solutions
11. **Contributing** â€” guidelines
12. **License** â€” MIT

---

## 12. Existing Implementation (Reference Files)

The following files have already been created and should be used as a starting point. They need to be adapted to match this PRD (especially `deploy.sh` which currently has hardcoded domain mappings and needs to be refactored to use the single-domain `.env.deploy` pattern).

### 12.1 `deploy.sh` (Current Version â€” Needs Refactoring)

The current version uses a hardcoded `DOMAINS` associative array and supports multi-domain selection. It needs to be refactored to:
- Read a single `DOMAIN` and `DOMAIN_TYPE` from `.env.deploy`
- Handle static vs dynamic deploy paths differently
- Add post-deploy commands for dynamic sites (npm install, pm2 restart)

```bash
#!/bin/bash
# ============================================
# deploy.sh - Build & Deploy to VPS
# ============================================
# Usage:
#   ./deploy.sh                  # Interactive domain selection
#   ./deploy.sh pescatoreluca    # Deploy to pescatoreluca.com
#   ./deploy.sh okrmd            # Deploy to okrmd.com
#   ./deploy.sh provaprova       # Deploy to provaprova.com
#   ./deploy.sh all              # Deploy to all domains
#
# Options:
#   --skip-build    Skip the build step (deploy existing out/ directory)
#   --dry-run       Show what would be transferred without actually doing it
#   --verbose       Show detailed rsync output
#
# Examples:
#   ./deploy.sh pescatoreluca --skip-build
#   ./deploy.sh okrmd --dry-run
#   ./deploy.sh all --verbose
# ============================================

set -euo pipefail

# =====================
# CONFIGURATION
# =====================

# Load environment variables from .env.deploy
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="${SCRIPT_DIR}/.env.deploy"

if [[ -f "$ENV_FILE" ]]; then
    # Source the file, ignoring comments and empty lines
    set -a
    source <(grep -v '^\s*#' "$ENV_FILE" | grep -v '^\s*$')
    set +a
else
    echo -e "\033[0;31mâŒ\033[0m  Missing .env.deploy file."
    echo ""
    echo "   Create one next to this script with:"
    echo ""
    echo "     VPS_USER=deploy"
    echo "     VPS_IP=164.90.xxx.xxx"
    echo "     SSH_KEY=~/.ssh/id_ed25519    # optional"
    echo "     SSH_PORT=22                   # optional"
    echo ""
    exit 1
fi

# Defaults for optional variables
VPS_USER="${VPS_USER:?VPS_USER is required in .env.deploy}"
VPS_IP="${VPS_IP:?VPS_IP is required in .env.deploy}"
VPS_BASE_PATH="${VPS_BASE_PATH:-/var/www}"
SSH_KEY="${SSH_KEY:-}"
SSH_PORT="${SSH_PORT:-22}"
BUILD_CMD="${BUILD_CMD:-npm run build}"
BUILD_OUTPUT="${BUILD_OUTPUT:-out}"

# Domain mapping: short_name -> full domain
declare -A DOMAINS=(
    ["pescatoreluca"]="pescatoreluca.com"
    ["okrmd"]="okrmd.com"
    ["provaprova"]="provaprova.com"
)

# =====================
# COLORS & FORMATTING
# =====================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# =====================
# HELPER FUNCTIONS
# =====================
log_info()    { echo -e "${BLUE}â„¹${NC}  $1"; }
log_success() { echo -e "${GREEN}âœ…${NC} $1"; }
log_warn()    { echo -e "${YELLOW}âš ï¸${NC}  $1"; }
log_error()   { echo -e "${RED}âŒ${NC} $1"; }
log_step()    { echo -e "\n${CYAN}${BOLD}â–¸ $1${NC}"; }

show_help() {
    head -20 "$0" | tail -18 | sed 's/^# //' | sed 's/^#//'
    exit 0
}

# =====================
# PARSE ARGUMENTS
# =====================
TARGET=""
SKIP_BUILD=false
DRY_RUN=false
VERBOSE=false

for arg in "$@"; do
    case "$arg" in
        --skip-build) SKIP_BUILD=true ;;
        --dry-run)    DRY_RUN=true ;;
        --verbose)    VERBOSE=true ;;
        --help|-h)    show_help ;;
        *)            TARGET="$arg" ;;
    esac
done

# =====================
# BUILD SSH/RSYNC OPTIONS
# =====================
SSH_OPTS="-p ${SSH_PORT}"
if [[ -n "$SSH_KEY" ]]; then
    SSH_OPTS="${SSH_OPTS} -i ${SSH_KEY}"
fi

RSYNC_OPTS="-az --delete --stats"
if [[ "$VERBOSE" == true ]]; then
    RSYNC_OPTS="${RSYNC_OPTS}v"
fi
if [[ "$DRY_RUN" == true ]]; then
    RSYNC_OPTS="${RSYNC_OPTS} --dry-run"
fi

# =====================
# DOMAIN SELECTION
# =====================
select_domain() {
    echo ""
    echo -e "${BOLD}Select a domain to deploy:${NC}"
    echo ""

    local i=1
    local keys=()
    for key in $(echo "${!DOMAINS[@]}" | tr ' ' '\n' | sort); do
        keys+=("$key")
        echo -e "  ${CYAN}${i})${NC} ${DOMAINS[$key]}"
        ((i++))
    done
    echo -e "  ${CYAN}${i})${NC} All domains"
    echo ""

    read -rp "Enter choice [1-${i}]: " choice

    if [[ "$choice" == "$i" ]]; then
        TARGET="all"
    elif [[ "$choice" -ge 1 && "$choice" -lt "$i" ]] 2>/dev/null; then
        TARGET="${keys[$((choice-1))]}"
    else
        log_error "Invalid selection."
        exit 1
    fi
}

# =====================
# BUILD
# =====================
build_site() {
    if [[ "$SKIP_BUILD" == true ]]; then
        log_warn "Skipping build (--skip-build)"
        if [[ ! -d "$BUILD_OUTPUT" ]]; then
            log_error "Build output directory '${BUILD_OUTPUT}/' not found. Run without --skip-build first."
            exit 1
        fi
        return
    fi

    log_step "Building site..."

    if [[ ! -f "package.json" ]]; then
        log_error "No package.json found. Run this script from your Next.js project root."
        exit 1
    fi

    $BUILD_CMD

    if [[ ! -d "$BUILD_OUTPUT" ]]; then
        log_error "Build output directory '${BUILD_OUTPUT}/' not found after build."
        log_error "Make sure next.config.js has: output: 'export'"
        exit 1
    fi

    local file_count
    file_count=$(find "$BUILD_OUTPUT" -type f | wc -l)
    log_success "Build complete (${file_count} files)"
}

# =====================
# DEPLOY
# =====================
deploy_to_domain() {
    local domain="$1"
    local remote_path="${VPS_BASE_PATH}/${domain}/"

    log_step "Deploying to ${domain}..."

    if [[ "$DRY_RUN" == true ]]; then
        log_warn "DRY RUN â€” no files will be transferred"
    fi

    # Test SSH connection first
    if ! ssh ${SSH_OPTS} -o ConnectTimeout=10 -o BatchMode=yes "${VPS_USER}@${VPS_IP}" "echo ok" &>/dev/null; then
        log_error "Cannot connect to ${VPS_USER}@${VPS_IP}:${SSH_PORT}"
        log_error "Check your SSH key, VPS_USER, VPS_IP, and SSH_PORT settings."
        exit 1
    fi

    # Ensure remote directory exists
    ssh ${SSH_OPTS} "${VPS_USER}@${VPS_IP}" "mkdir -p ${remote_path}"

    # Deploy with rsync
    rsync ${RSYNC_OPTS} \
        -e "ssh ${SSH_OPTS}" \
        "${BUILD_OUTPUT}/" \
        "${VPS_USER}@${VPS_IP}:${remote_path}"

    if [[ "$DRY_RUN" == false ]]; then
        log_success "${domain} deployed successfully"

        # Show quick verification
        echo -e "    ${BOLD}Verify:${NC} https://${domain}"
    fi
}

# =====================
# MAIN
# =====================
echo ""
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}  ğŸš€ VPS Deploy Script${NC}"
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# If no target specified, show interactive menu
if [[ -z "$TARGET" ]]; then
    select_domain
fi

# Validate target
if [[ "$TARGET" != "all" && -z "${DOMAINS[$TARGET]+x}" ]]; then
    log_error "Unknown domain: '${TARGET}'"
    log_info "Available: ${!DOMAINS[*]} all"
    exit 1
fi

# Build
build_site

# Deploy
START_TIME=$(date +%s)

if [[ "$TARGET" == "all" ]]; then
    log_info "Deploying to all domains..."
    for key in "${!DOMAINS[@]}"; do
        deploy_to_domain "${DOMAINS[$key]}"
    done
else
    deploy_to_domain "${DOMAINS[$TARGET]}"
fi

END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))

echo ""
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if [[ "$DRY_RUN" == true ]]; then
    log_warn "Dry run complete (${ELAPSED}s)"
else
    log_success "All done! (${ELAPSED}s)"
fi
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
```

### 12.2 `.env.deploy.example` (Current Version â€” Needs Updating)

Needs to be updated to include `DOMAIN`, `DOMAIN_TYPE`, and `DOMAIN_PORT` fields.

```bash
# ============================================
# VPS Deploy Configuration
# ============================================
# Copy this file to .env.deploy and fill in your values:
#   cp .env.deploy.example .env.deploy
#
# IMPORTANT: Never commit .env.deploy to git!
# ============================================

# Required
VPS_USER=deploy
VPS_IP=164.90.xxx.xxx

# Optional (defaults shown)
# SSH_KEY=~/.ssh/id_ed25519
# SSH_PORT=22
# VPS_BASE_PATH=/var/www
# BUILD_CMD=npm run build
# BUILD_OUTPUT=out
```

### 12.3 VPS Setup Guide (Reference Only)

A manual step-by-step guide has been created at `vps-setup-guide.md`. This serves as reference documentation for understanding what `setup-vps.sh` automates. It should be included in the repo as `docs/manual-setup-guide.md`.

---

## 13. Implementation Priority

### Phase 1 (MVP)
1. Refactor `.env.deploy.example` with new schema
2. Implement `setup-vps.sh` (default subcommand only â€” setup/update)
3. Refactor `deploy.sh` to use single-domain `.env.deploy`
4. Write `README.md`

### Phase 2
5. Implement `setup-vps.sh status`
6. Implement `setup-vps.sh remove`
7. Add `--dry-run` to `setup-vps.sh`

### Phase 3 (Polish)
8. Add comprehensive error handling for all edge cases in Â§9
9. Add `--verbose` flag
10. Write `CONTRIBUTING.md`
11. Include `docs/manual-setup-guide.md`

---

## 14. Testing Checklist

Before considering the implementation complete, verify these scenarios:

- [ ] Fresh VPS: `setup-vps.sh` installs everything from scratch for a static domain
- [ ] Fresh VPS: `setup-vps.sh` installs everything from scratch for a dynamic domain
- [ ] Second domain: running from a different repo adds to existing registry
- [ ] Re-run: running `setup-vps.sh` twice produces identical results (idempotent)
- [ ] Type change: changing `DOMAIN_TYPE` from static to dynamic updates everything correctly
- [ ] Port conflict: setting same port as existing dynamic domain produces clear error
- [ ] Deploy static: `deploy.sh` builds and rsyncs to correct path
- [ ] Deploy dynamic: `deploy.sh` rsyncs, runs npm install, restarts PM2
- [ ] `setup-vps.sh status`: shows all domains with correct status
- [ ] `setup-vps.sh remove`: removes domain, regenerates Caddyfile, stops PM2
- [ ] Caddy validation failure: backup is restored, old config stays active
- [ ] SSH failure: clear error message, no partial changes
- [ ] Missing `.env.deploy`: clear error with template
